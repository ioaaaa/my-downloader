name: YouTube Downloader Pro
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'YouTube Video URL'
        required: true

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Node.js (解决 n-challenge 关键)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install yt-dlp and EJS
        run: |
          # 2026年策略：使用 pip 安装并附带 ejs 补丁
          python3 -m pip install -U pip
          python3 -m pip install -U "yt-dlp[default]" yt-dlp-ejs

      - name: Create Cookie File
        run: |
          echo "${{ secrets.YT_COOKIES }}" > cookies.txt

      - name: Download Video
        run: |
          # 加上 --extractor-args 来尝试绕过特定的客户端限制
          yt-dlp --cookies cookies.txt \
                 --extractor-args "youtube:player_client=tv,web" \
                 -f "bestvideo[height<=1080]+bestaudio/best" \
                 "${{ github.event.inputs.video_url }}" \
                 -o "video.mp4"

      - name: Upload to Transfer.sh
        run: |
          curl --upload-file ./video.mp4 https://transfer.sh/video.mp4 > download_link.txt
          echo "Your download link is: "
          cat download_link.txt
